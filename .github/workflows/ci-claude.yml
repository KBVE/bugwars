name: CI - Claude User Verification

on:
    workflow_dispatch:

jobs:
    verify-user:
        name: Verify Push from Claude User
        runs-on: ubuntu-latest
        outputs:
            is_claude: ${{ steps.verify.outputs.is_claude }}
            commit_author: ${{ steps.verify.outputs.commit_author }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Verify commit author
              id: verify
              run: |
                  # Get the commit author username
                  AUTHOR_USERNAME="${{ github.event.pusher.name }}"
                  COMMIT_AUTHOR="${{ github.event.head_commit.author.username }}"

                  echo "Pusher name: ${AUTHOR_USERNAME}"
                  echo "Commit author username: ${COMMIT_AUTHOR}"
                  echo "GitHub actor: ${{ github.actor }}"

                  # Check if any of the identifiers match "claude"
                  if [ "${{ github.actor }}" = "claude" ] || [ "${COMMIT_AUTHOR}" = "claude" ]; then
                      echo "‚úÖ Verified: Push is from user 'claude'"
                      echo "is_claude=true" >> $GITHUB_OUTPUT
                      echo "commit_author=claude" >> $GITHUB_OUTPUT
                  else
                      echo "‚ùå Verification failed: Push is NOT from user 'claude'"
                      echo "   GitHub actor: ${{ github.actor }}"
                      echo "   Commit author: ${COMMIT_AUTHOR}"
                      echo "is_claude=false" >> $GITHUB_OUTPUT
                      echo "commit_author=${{ github.actor }}" >> $GITHUB_OUTPUT
                      exit 1
                  fi

    create-pr:
        name: Create Pull Request to Main
        needs: verify-user
        if: needs.verify-user.outputs.is_claude == 'true'
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Get branch changes summary
              id: changes
              run: |
                  # Get the current branch name
                  BRANCH_NAME="${{ github.ref_name }}"

                  # Get list of changed files
                  git fetch origin main
                  CHANGED_FILES=$(git diff --name-only origin/main...HEAD)

                  echo "Changed files:"
                  echo "$CHANGED_FILES"

                  # Count changes
                  NUM_FILES=$(echo "$CHANGED_FILES" | wc -l)

                  # Create a summary
                  SUMMARY="This PR includes changes from branch \`${BRANCH_NAME}\` verified to be from user @claude."

                  # Save for PR body
                  echo "summary<<EOF" >> $GITHUB_OUTPUT
                  echo "$SUMMARY" >> $GITHUB_OUTPUT
                  echo "" >> $GITHUB_OUTPUT
                  echo "### Changed Files (${NUM_FILES})" >> $GITHUB_OUTPUT
                  echo "\`\`\`" >> $GITHUB_OUTPUT
                  echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
                  echo "\`\`\`" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  branch: ${{ github.ref_name }}
                  base: main
                  title: "[${{ github.ref_name }}] Changes verified from @claude"
                  body: |
                      ## ‚úÖ Claude User Verification Passed

                      ${{ steps.changes.outputs.summary }}

                      ### Verification Details
                      - **Author:** @${{ needs.verify-user.outputs.commit_author }}
                      - **Branch:** `${{ github.ref_name }}`
                      - **Commit:** ${{ github.sha }}
                      - **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

                      ---
                      ü§ñ This PR was automatically created by the Claude user verification workflow.

                      The commits in this PR have been verified to come from the [@claude](https://github.com/claude) user.
                  labels: |
                      automated
                      claude-verified

    verification-failed:
        name: Handle Verification Failure
        needs: verify-user
        if: needs.verify-user.outputs.is_claude == 'false'
        runs-on: ubuntu-latest
        steps:
            - name: Report verification failure
              run: |
                  echo "‚ö†Ô∏è  Verification Failed"
                  echo ""
                  echo "This push was not from user 'claude'."
                  echo "Actual author: ${{ needs.verify-user.outputs.commit_author }}"
                  echo ""
                  echo "No pull request will be created."
                  exit 1
